#!/bin/bash

USER_ID=memorable_string_of_words
INPUT_FOLDER=src
MEASUREMENT=63
SILENT_RUNNING=0

USAGE="Usage: `basename $0` [-h] [-q] [-m measurement] [-u user_id] [-o output_folder] [-i input_folder] "

#Parse the command line options
while getopts hqm:u:o:i: OPT; do 
    case "$OPT" in 
        h)
            echo $USAGE
            exit 0
            ;;
        q)
            SILENT_RUNNING=1
            ;;
        m)
            MEASUREMENT=$OPTARG
            ;;
        u)
            USER_ID=$OPTARG
            ;;
        o)
            OUTPUT_FOLDER=$OPTARG
            ;;
        i)
            INPUT_FOLDER=$OPTARG
            ;;
    esac
done

# ask for input if not in silent running mode
if [ $SILENT_RUNNING -eq 0 ]
then
    read -p "Input user id [$USER_ID]: " INPUT
    [[ -n "$INPUT" ]] && USER_ID=$INPUT

    read -p "Input cross-hand measurement (mm) [$MEASUREMENT]: " INPUT
    [[ -n "$INPUT" ]] && MEASUREMENT=$INPUT
fi

OUTPUT_FOLDER=hands/$USER_ID

# make the directory in case it doesn't exist
mkdir -p $OUTPUT_FOLDER

# do the actual creation of the files
for I in $INPUT_FOLDER/*.stl
do 
    IN=$(echo $I | sed "s:stl:scad:")
    OUT=$(echo "$I" | sed "s:$INPUT_FOLDER/:$OUTPUT_FOLDER/:g")
    echo -n $IN
    echo -n ' -> '
    echo $OUT
    openscad -o $OUT -D measurement=$MEASUREMENT $IN
done
